<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>First Party SNT Document Generation Test</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1000px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #4CAF50;
      padding-bottom: 10px;
    }
    .test-info {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
      border-left: 4px solid #2196F3;
    }
    .button {
      background: #4CAF50;
      color: white;
      padding: 15px 30px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px 5px;
    }
    .button:hover {
      background: #45a049;
    }
    .button.secondary {
      background: #2196F3;
    }
    .button.secondary:hover {
      background: #0b7dda;
    }
    #status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 5px;
      display: none;
    }
    #status.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
      display: block;
    }
    #status.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
      display: block;
    }
    #status.info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
      display: block;
    }
    .log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 5px;
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #4CAF50;
      padding-left: 10px;
    }
    .log-error {
      border-left-color: #f44336;
      color: #ff6b6b;
    }
    .log-success {
      border-left-color: #4CAF50;
      color: #4CAF50;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ First Party SNT Document Generation Test</h1>

    <div class="test-info">
      <h3>Test Details:</h3>
      <ul>
        <li><strong>Trust Type:</strong> First Party SNT (Single)</li>
        <li><strong>Template:</strong> /templates/first_party_snt_template.docx</li>
        <li><strong>Beneficiary:</strong> Emily Grace Smith (also the grantor in First Party SNT)</li>
        <li><strong>Current Trustee:</strong> David Paul Anderson (single trustee test)</li>
      </ul>
    </div>

    <button class="button" onclick="runTest('single')">‚ñ∂Ô∏è Generate Single Trustee</button>
    <button class="button secondary" onclick="runTest('joint')">‚ñ∂Ô∏è Generate Joint Trustees</button>
    <button class="button" onclick="clearLog()">üóëÔ∏è Clear Log</button>

    <div id="status"></div>
    <div id="log" class="log"></div>
  </div>

  <script type="module">
    import { generateFromDOCXTemplate } from '/src/services/docxTemplateService.js';
    import { getDOCXTemplatePath } from '/src/services/docxTemplateConfig.js';

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type === 'error' ? 'log-error' : type === 'success' ? 'log-success' : ''}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    function showStatus(message, type) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = type;
    }

    window.clearLog = function() {
      document.getElementById('log').innerHTML = '';
      document.getElementById('status').style.display = 'none';
    };

    window.runTest = async function(testType) {
      log(`üöÄ Starting ${testType} trustee test...`, 'info');
      showStatus('Generating document...', 'info');

      // Base test data
      const testData = {
        trustType: 'first_party_snt',
        trustName: 'Emily Grace Smith Special Needs Trust',
        trustDate: '2025-11-02',

        // Beneficiary (who is also the grantor in First Party SNT)
        sntData: {
          beneficiary: {
            firstName: 'Emily',
            middleName: 'Grace',
            lastName: 'Smith',
            dateOfBirth: '1995-08-20',
            sex: 'female',
            ssn: '123-45-6789',
            disabilityDescription: 'Emily has cerebral palsy and requires ongoing medical care and assistance with daily living activities.'
          },
          governmentBenefits: {
            ssi: true,
            ssdi: true,
            mediCal: true,
            medicare: false,
            housingAssistance: false,
            other: ''
          },
          remainderBeneficiaries: [
            {
              firstName: 'Michael',
              middleName: 'James',
              lastName: 'Smith'
            },
            {
              firstName: 'Sarah',
              middleName: 'Ann',
              lastName: 'Johnson'
            }
          ],
          notaryName: 'Robert Williams',
          notaryDate: '2025-11-02',
          scheduleAProperty: `1. Real Property: Single family residence located at 123 Main Street, Los Angeles, CA 90001
2. Bank Accounts: Wells Fargo Account #12345678
3. Investment Accounts: Vanguard Account #98765432
4. Personal Property: All household furnishings and personal effects`
        },

        // Current Trustees - varies based on test
        currentTrustees: testType === 'joint' ? [
          {
            firstName: 'David',
            middleName: 'Paul',
            lastName: 'Anderson',
            address: '456 Oak Avenue, Los Angeles, CA 90002',
            phone: '(555) 234-5678'
          },
          {
            firstName: 'Lisa',
            middleName: 'Marie',
            lastName: 'Thompson',
            address: '789 Pine Street, Los Angeles, CA 90003',
            phone: '(555) 345-6789'
          }
        ] : [
          {
            firstName: 'David',
            middleName: 'Paul',
            lastName: 'Anderson',
            address: '456 Oak Avenue, Los Angeles, CA 90002',
            phone: '(555) 234-5678'
          }
        ],

        // Successor Trustees
        successorTrustees: [
          {
            firstName: 'Robert',
            middleName: 'Lee',
            lastName: 'Davis',
            address: '321 Elm Drive, Los Angeles, CA 90004',
            phone: '(555) 456-7890'
          }
        ]
      };

      try {
        // Step 1: Get template path
        log('üìÅ Getting template path...', 'info');
        const templatePath = getDOCXTemplatePath(testData, false);
        log(`   Template path: ${templatePath}`, 'success');

        // Step 2: Generate document
        log('‚öôÔ∏è  Generating document from template...', 'info');
        const blob = await generateFromDOCXTemplate(testData, templatePath);

        if (!blob) {
          throw new Error('Document generation returned null/undefined');
        }

        if (!(blob instanceof Blob)) {
          throw new Error('Document generation did not return a Blob');
        }

        log(`‚úÖ Document generated successfully!`, 'success');
        log(`   Blob size: ${blob.size.toLocaleString()} bytes`, 'success');

        // Step 3: Download the document
        log('üíæ Preparing download...', 'info');
        const fileName = `test-first-party-snt-${testType}-${new Date().toISOString().split('T')[0]}.docx`;
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        log(`   Filename: ${fileName}`, 'success');
        log('‚úÖ Document downloaded successfully!', 'success');

        if (testType === 'single') {
          log('\n‚ö†Ô∏è  VERIFY: Check that trustee line reads "David Paul Anderson, Trustee" (NO extra "and")', 'info');
        } else {
          log('\n‚ö†Ô∏è  VERIFY: Check that trustee line reads "David Paul Anderson and Lisa Marie Thompson, Trustees"', 'info');
        }

        showStatus('‚úÖ Success! Document generated and downloaded.', 'success');

      } catch (error) {
        log(`‚ùå ERROR: ${error.message}`, 'error');
        log(`Stack: ${error.stack}`, 'error');
        showStatus(`‚ùå Error: ${error.message}`, 'error');
        console.error('Full error:', error);
      }
    };
  </script>
</body>
</html>
